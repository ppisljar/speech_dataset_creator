<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Management System</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="web/css/main.css">
    <link rel="stylesheet" href="web/components/data-viewer/data-viewer.css">
    <!-- NProgress CSS for HTTP request progress bar -->
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
</head>
<body>
    <div class="container">
        <div class="main-header">
            <h1>Podcast Management System</h1>
            <div class="status-icon-container">
                <div class="status-icon" onclick="loadProcessingStatus()" title="Processing Status">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </div>
                <div class="status-tooltip" id="statusTooltip">
                    <div class="status-tooltip-header">
                        <span>Processing Status</span>
                        <button onclick="refreshProcessingStatus()" class="refresh-btn" title="Refresh">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                            </svg>
                        </button>
                    </div>
                    <div id="statusTooltipContent" class="status-tooltip-content">
                        No processing activities found.
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Project Header with unified controls -->
        <div class="project-header">
            <h2>Project:</h2>
            <div class="project-controls">
                <select id="globalProjectSelect">
                    <option value="">Select Project</option>
                </select>
                <div class="icon-buttons">
                    <button class="icon-btn" onclick="showAddProjectModal()" title="Add Project">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                        </svg>
                    </button>
                    <button class="icon-btn" onclick="deleteSelectedProject()" id="deleteProjectBtn" disabled title="Delete Project">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                    <button class="icon-btn" onclick="showEditProjectModal()" id="editProjectBtn" disabled title="Edit Project">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                        </svg>
                    </button>
                </div>
                <div class="file-controls">
                    <input type="file" id="fileUpload">
                    <button class="icon-btn" onclick="uploadFile()" title="Upload File">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                    </button>
                    <button class="icon-btn run-btn" onclick="runAllFiles()" id="runAllBtn" disabled title="Run All">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                        </svg>
                    </button>
                    <button class="icon-btn clean-btn" onclick="cleanProject()" id="cleanProjectBtn" disabled title="Clean Project">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"/>
                        </svg>
                    </button>
                    <button class="icon-btn export-btn" onclick="exportProject()" id="exportProjectBtn" disabled title="Export Project">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z M15,11H13V16L15.5,13.5L17,15L12,20L7,15L8.5,13.5L11,16V11H9L12,8L15,11Z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Data Viewer</h2>
            <!-- Data Viewer Component -->
            <div id="dataViewerComponent"></div>
        </div>

        <div id="messages"></div>
    </div>

    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Project</h3>
                <span class="close" onclick="closeModal('addProjectModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="modalProjectName">Project Name:</label>
                <input type="text" id="modalProjectName" placeholder="Enter project name">
            </div>
            <div class="form-group">
                <label for="modalSilenceThreshold">Silence Threshold (dB):</label>
                <input type="number" id="modalSilenceThreshold" value="-45" step="1" min="-100" max="0">
            </div>
            <div class="form-group">
                <label for="modalMinSilenceLength">Minimum Silence Length (ms):</label>
                <input type="number" id="modalMinSilenceLength" value="100" step="100" min="100">
            </div>
            <div class="form-group">
                <label for="modalMaxSpeakers">Max Speakers (0 = auto-detect):</label>
                <input type="number" id="modalMaxSpeakers" value="0" step="1" min="0" max="20">
            </div>
            <div class="form-group">
                <label for="modalSilencePad">Silence Padding (ms):</label>
                <input type="number" id="modalSilencePad" value="50" step="10" min="0" max="500">
            </div>
            <div class="form-group">
                <label for="modalLanguage">Transcription Language:</label>
                <select id="modalLanguage">
                    <option value="sl">Slovenian (sl)</option>
                    <option value="en">English (en)</option>
                    <option value="de">German (de)</option>
                    <option value="fr">French (fr)</option>
                    <option value="es">Spanish (es)</option>
                    <option value="it">Italian (it)</option>
                    <option value="pt">Portuguese (pt)</option>
                    <option value="nl">Dutch (nl)</option>
                    <option value="pl">Polish (pl)</option>
                    <option value="cs">Czech (cs)</option>
                    <option value="sk">Slovak (sk)</option>
                    <option value="hr">Croatian (hr)</option>
                    <option value="sr">Serbian (sr)</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="modalBuildSubsegments" checked>
                    Build Subsegments
                </label>
                <small>Generate subsegments from main segments based on pauses and punctuation</small>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="modalJoinSubsegments">
                    Join Subsegments
                </label>
                <small>Create additional subsegments by joining consecutive subsegments (requires Build Subsegments)</small>
            </div>
            <div class="button-group">
                <button onclick="closeModal('addProjectModal')">Cancel</button>
                <button onclick="createProjectWithSettings()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Project</h3>
                <span class="close" onclick="closeModal('editProjectModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="editProjectName">Project Name:</label>
                <input type="text" id="editProjectName" placeholder="Enter project name">
            </div>
            <div class="form-group">
                <label for="editSilenceThreshold">Silence Threshold (dB):</label>
                <input type="number" id="editSilenceThreshold" value="-40" step="1" min="-100" max="0">
            </div>
            <div class="form-group">
                <label for="editMinSilenceLength">Minimum Silence Length (ms):</label>
                <input type="number" id="editMinSilenceLength" value="500" step="100" min="100">
            </div>
            <div class="form-group">
                <label for="editMaxSpeakers">Max Speakers (0 = auto-detect):</label>
                <input type="number" id="editMaxSpeakers" value="0" step="1" min="0" max="20">
            </div>
            <div class="form-group">
                <label for="editSilencePad">Silence Padding (ms):</label>
                <input type="number" id="editSilencePad" value="50" step="10" min="0" max="500">
            </div>
            <div class="form-group">
                <label for="editLanguage">Transcription Language:</label>
                <select id="editLanguage">
                    <option value="sl">Slovenian (sl)</option>
                    <option value="en">English (en)</option>
                    <option value="de">German (de)</option>
                    <option value="fr">French (fr)</option>
                    <option value="es">Spanish (es)</option>
                    <option value="it">Italian (it)</option>
                    <option value="pt">Portuguese (pt)</option>
                    <option value="nl">Dutch (nl)</option>
                    <option value="pl">Polish (pl)</option>
                    <option value="cs">Czech (cs)</option>
                    <option value="sk">Slovak (sk)</option>
                    <option value="hr">Croatian (hr)</option>
                    <option value="sr">Serbian (sr)</option>
                </select>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="editBuildSubsegments" checked>
                    Build Subsegments
                </label>
                <small>Generate subsegments from main segments based on pauses and punctuation</small>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="editJoinSubsegments">
                    Join Subsegments
                </label>
                <small>Create additional subsegments by joining consecutive subsegments (requires Build Subsegments)</small>
            </div>
            <div class="button-group">
                <button onclick="closeModal('editProjectModal')">Cancel</button>
                <button onclick="updateProjectWithSettings()">Update Project</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script src="web/js/main.js"></script>
    <script src="web/js/audio-controller.js"></script>
    <script src="web/js/segments-manager.js"></script>
    <script src="web/components/data-viewer/data-viewer.js"></script>
    
    <script>
        // Configure NProgress
        NProgress.configure({ 
            showSpinner: false,
            minimum: 0.08,
            easing: 'ease',
            speed: 200
        });

        // Track active HTTP requests
        let activeRequests = 0;

        // Override fetch to automatically show/hide progress bar
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            // Start progress if this is the first request
            if (activeRequests === 0) {
                NProgress.start();
            }
            activeRequests++;

            return originalFetch.apply(this, args)
                .then(response => {
                    activeRequests--;
                    // Complete progress if this was the last request
                    if (activeRequests === 0) {
                        NProgress.done();
                    }
                    return response;
                })
                .catch(error => {
                    activeRequests--;
                    // Complete progress even on error
                    if (activeRequests === 0) {
                        NProgress.done();
                    }
                    throw error;
                });
        };

        // Initialize the data viewer component when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load the data viewer HTML into the component container
            fetch('web/components/data-viewer/data-viewer.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('dataViewerComponent').innerHTML = html;
                    // Setup data viewer listeners after the component is loaded
                    if (window.podcastManager) {
                        window.podcastManager.setupDataViewerListeners();
                    }
                })
                .catch(error => {
                    console.error('Error loading data viewer component:', error);
                });
        });
    </script>
</body>
</html>
