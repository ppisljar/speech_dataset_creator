<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Management System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .file-list, .project-list {
            margin: 10px 0;
        }
        .item {
            padding: 5px;
            margin: 2px 0;
            background-color: #f8f9fa;
            border-radius: 3px;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .success {
            color: green;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Podcast Management System</h1>
        
        <div class="section">
            <h2>Projects</h2>
            <div>
                <input type="text" id="newProjectName" placeholder="Project name">
                <button onclick="createProject()">Create Project</button>
                <button onclick="loadProjects()">Refresh Projects</button>
            </div>
            <div id="projectsList" class="project-list"></div>
        </div>

        <div class="section">
            <h2>Files</h2>
            <div>
                <select id="projectSelect">
                    <option value="">Select Project</option>
                </select>
                <select id="filetypeSelect">
                    <option value="audio">Audio</option>
                    <option value="raw">Raw</option>
                    <option value="splits">Splits</option>
                </select>
                <button onclick="loadFiles()">Load Files</button>
            </div>
            <div>
                <input type="file" id="fileUpload">
                <button onclick="uploadFile()">Upload File</button>
            </div>
            <div id="filesList" class="file-list"></div>
        </div>

        <div class="section">
            <h2>Data Viewer</h2>
            <div>
                <select id="dataProjectSelect">
                    <option value="">Select Project</option>
                </select>
                <input type="text" id="dataFilename" placeholder="Filename">
                <select id="dataType">
                    <option value="silences">Silences</option>
                    <option value="transcriptions">Transcriptions</option>
                    <option value="pyannote">Pyannote</option>
                    <option value="segments">Segments</option>
                    <option value="splits">Splits</option>
                </select>
                <button onclick="loadData()">Load Data</button>
                <button onclick="refreshFile()">Refresh File</button>
            </div>
            <div id="dataViewer" style="background-color: #f8f9fa; padding: 10px; margin: 10px 0; min-height: 100px; overflow: auto;"></div>
        </div>

        <div class="section">
            <h2>Processing Status</h2>
            <div>
                <button onclick="loadProcessingStatus()">Refresh Status</button>
            </div>
            <div id="processingStatus" style="background-color: #f8f9fa; padding: 10px; margin: 10px 0; min-height: 100px; overflow: auto;"></div>
        </div>

        <div id="messages"></div>
    </div>

    <script>
        // Load projects on page load
        window.onload = function() {
            loadProjects();
            loadProcessingStatus();
        };

        function showMessage(message, isError = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isError ? 'error' : 'success';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 5000);
        }

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const projects = await response.json();
                
                const projectsList = document.getElementById('projectsList');
                const projectSelect = document.getElementById('projectSelect');
                const dataProjectSelect = document.getElementById('dataProjectSelect');
                
                projectsList.innerHTML = '';
                projectSelect.innerHTML = '<option value="">Select Project</option>';
                dataProjectSelect.innerHTML = '<option value="">Select Project</option>';
                
                projects.forEach(project => {
                    // Add to projects list
                    const projectDiv = document.createElement('div');
                    projectDiv.className = 'item';
                    projectDiv.innerHTML = `
                        <span>${project}</span>
                        <button onclick="deleteProject('${project}')">Delete</button>
                    `;
                    projectsList.appendChild(projectDiv);
                    
                    // Add to selects
                    const option1 = document.createElement('option');
                    option1.value = project;
                    option1.textContent = project;
                    projectSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = project;
                    option2.textContent = project;
                    dataProjectSelect.appendChild(option2);
                });
            } catch (error) {
                showMessage('Error loading projects: ' + error.message, true);
            }
        }

        async function createProject() {
            const name = document.getElementById('newProjectName').value;
            if (!name) {
                showMessage('Please enter a project name', true);
                return;
            }

            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ name: name })
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage(result.message);
                    document.getElementById('newProjectName').value = '';
                    loadProjects();
                } else {
                    showMessage(result.error, true);
                }
            } catch (error) {
                showMessage('Error creating project: ' + error.message, true);
            }
        }

        async function deleteProject(projectName) {
            if (!confirm(`Are you sure you want to delete project "${projectName}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${projectName}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage(result.message);
                    loadProjects();
                } else {
                    showMessage(result.error, true);
                }
            } catch (error) {
                showMessage('Error deleting project: ' + error.message, true);
            }
        }

        async function loadFiles() {
            const project = document.getElementById('projectSelect').value;
            const filetype = document.getElementById('filetypeSelect').value;
            
            if (!project) {
                showMessage('Please select a project', true);
                return;
            }

            try {
                const response = await fetch(`/api/projects/${project}/files/${filetype}`);
                const files = await response.json();
                
                const filesList = document.getElementById('filesList');
                filesList.innerHTML = '';
                
                files.forEach(file => {
                    const fileDiv = document.createElement('div');
                    fileDiv.className = 'item';
                    fileDiv.innerHTML = `
                        <span>${file}</span>
                        <button onclick="deleteFile('${project}', '${filetype}', '${file}')">Delete</button>
                    `;
                    filesList.appendChild(fileDiv);
                });
            } catch (error) {
                showMessage('Error loading files: ' + error.message, true);
            }
        }

        async function uploadFile() {
            const project = document.getElementById('projectSelect').value;
            const filetype = document.getElementById('filetypeSelect').value;
            const fileInput = document.getElementById('fileUpload');
            
            if (!project) {
                showMessage('Please select a project', true);
                return;
            }
            
            if (!fileInput.files[0]) {
                showMessage('Please select a file', true);
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                const response = await fetch(`/api/projects/${project}/files/${filetype}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage(result.message);
                    fileInput.value = '';
                    loadFiles();
                } else {
                    showMessage(result.error, true);
                }
            } catch (error) {
                showMessage('Error uploading file: ' + error.message, true);
            }
        }

        async function deleteFile(project, filetype, filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${project}/files/${filetype}/${filename}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage(result.message);
                    loadFiles();
                } else {
                    showMessage(result.error, true);
                }
            } catch (error) {
                showMessage('Error deleting file: ' + error.message, true);
            }
        }

        async function loadData() {
            const project = document.getElementById('dataProjectSelect').value;
            const filename = document.getElementById('dataFilename').value;
            const dataType = document.getElementById('dataType').value;
            
            if (!project) {
                showMessage('Please select a project', true);
                return;
            }
            
            if (!filename) {
                showMessage('Please enter a filename', true);
                return;
            }

            try {
                let url;
                if (dataType === 'splits') {
                    url = `/api/projects/${project}/splits/${filename}`;
                } else {
                    url = `/api/projects/${project}/${dataType}/${filename}`;
                }

                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('dataViewer').innerHTML = 
                        '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    showMessage(data.error, true);
                    document.getElementById('dataViewer').innerHTML = '';
                }
            } catch (error) {
                showMessage('Error loading data: ' + error.message, true);
            }
        }

        async function refreshFile() {
            const project = document.getElementById('dataProjectSelect').value;
            const filename = document.getElementById('dataFilename').value;
            
            if (!project) {
                showMessage('Please select a project', true);
                return;
            }
            
            if (!filename) {
                showMessage('Please enter a filename', true);
                return;
            }

            try {
                const response = await fetch(`/api/projects/${project}/splits/${filename}/refresh`, {
                    method: 'POST'
                });

                const result = await response.json();
                if (response.ok) {
                    showMessage(result.message);
                    if (result.processing_key) {
                        // Start monitoring the processing status
                        monitorProcessing(project, filename);
                    }
                } else {
                    showMessage(result.error, true);
                }
            } catch (error) {
                showMessage('Error refreshing file: ' + error.message, true);
            }
        }

        async function loadProcessingStatus() {
            try {
                const response = await fetch('/api/processing/status');
                const statuses = await response.json();
                
                const statusDiv = document.getElementById('processingStatus');
                if (Object.keys(statuses).length === 0) {
                    statusDiv.innerHTML = '<p>No processing activities found.</p>';
                    return;
                }

                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<tr><th style="border: 1px solid #ddd; padding: 8px;">File</th><th style="border: 1px solid #ddd; padding: 8px;">Status</th><th style="border: 1px solid #ddd; padding: 8px;">Progress</th><th style="border: 1px solid #ddd; padding: 8px;">Message</th><th style="border: 1px solid #ddd; padding: 8px;">Started</th></tr>';
                
                for (const [key, status] of Object.entries(statuses)) {
                    const progressColor = status.status === 'completed' ? 'green' : 
                                        status.status === 'failed' ? 'red' : 'blue';
                    html += `<tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${key}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; color: ${progressColor};">${status.status}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${status.progress}%</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${status.message}</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${new Date(status.started_at).toLocaleString()}</td>
                    </tr>`;
                }
                html += '</table>';
                
                statusDiv.innerHTML = html;
            } catch (error) {
                showMessage('Error loading processing status: ' + error.message, true);
            }
        }

        async function monitorProcessing(project, filename) {
            const checkStatus = async () => {
                try {
                    const response = await fetch(`/api/projects/${project}/processing/${filename}/status`);
                    const status = await response.json();
                    
                    if (response.ok) {
                        if (status.status === 'processing') {
                            showMessage(`Processing ${filename}: ${status.progress}% - ${status.message}`);
                            // Check again in 2 seconds
                            setTimeout(checkStatus, 2000);
                        } else if (status.status === 'completed') {
                            showMessage(`Processing completed for ${filename}!`);
                            loadProcessingStatus();
                        } else if (status.status === 'failed') {
                            showMessage(`Processing failed for ${filename}: ${status.message}`, true);
                            loadProcessingStatus();
                        }
                    }
                } catch (error) {
                    console.error('Error checking status:', error);
                }
            };
            
            checkStatus();
        }

        // Auto-refresh processing status every 10 seconds
        setInterval(loadProcessingStatus, 10000);
    </script>
</body>
</html>