<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Management System</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="web/css/main.css">
    <link rel="stylesheet" href="web/components/data-viewer/data-viewer.css">
    <!-- NProgress CSS for HTTP request progress bar -->
    <link rel="stylesheet" href="https://unpkg.com/nprogress@0.2.0/nprogress.css">
</head>
<body>
    <div class="container">
        <h1>Podcast Management System</h1>
        
        <!-- Project Header with unified controls -->
        <div class="project-header">
            <h2>Project:</h2>
            <div class="project-controls">
                <select id="globalProjectSelect">
                    <option value="">Select Project</option>
                </select>
                <button onclick="showAddProjectModal()">Add</button>
                <button onclick="deleteSelectedProject()" id="deleteProjectBtn" disabled>Delete</button>
                <button onclick="showEditProjectModal()" id="editProjectBtn" disabled>Edit</button>
                <div>
                    <input type="file" id="fileUpload">
                    <button onclick="uploadFile()">Upload File</button>
                    <button onclick="runAllFiles()" id="runAllBtn" disabled style="background-color: #007bff; color: white;">Run All</button>
                    <button onclick="cleanProject()" id="cleanProjectBtn" disabled style="background-color: #dc3545; color: white;">Clean</button>
                    <button onclick="exportProject()" id="exportProjectBtn" disabled style="background-color: #28a745; color: white;">Export</button>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Data Viewer</h2>
            <!-- Data Viewer Component -->
            <div id="dataViewerComponent"></div>
        </div>

        <div class="section">
            <h2>Processing Status</h2>
            <div>
                <button onclick="loadProcessingStatus()">Refresh Status</button>
            </div>
            <div id="processingStatus" style="background-color: #f8f9fa; padding: 10px; margin: 10px 0; min-height: 100px; overflow: auto;"></div>
        </div>

        <div id="messages"></div>
    </div>

    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Project</h3>
                <span class="close" onclick="closeModal('addProjectModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="modalProjectName">Project Name:</label>
                <input type="text" id="modalProjectName" placeholder="Enter project name">
            </div>
            <div class="form-group">
                <label for="modalSilenceThreshold">Silence Threshold (dB):</label>
                <input type="number" id="modalSilenceThreshold" value="-45" step="1" min="-100" max="0">
            </div>
            <div class="form-group">
                <label for="modalMinSilenceLength">Minimum Silence Length (ms):</label>
                <input type="number" id="modalMinSilenceLength" value="100" step="100" min="100">
            </div>
            <div class="form-group">
                <label for="modalMaxSpeakers">Max Speakers (0 = auto-detect):</label>
                <input type="number" id="modalMaxSpeakers" value="0" step="1" min="0" max="20">
            </div>
            <div class="form-group">
                <label for="modalSilencePad">Silence Padding (ms):</label>
                <input type="number" id="modalSilencePad" value="50" step="10" min="0" max="500">
            </div>
            <div class="form-group">
                <label for="modalLanguage">Transcription Language:</label>
                <select id="modalLanguage">
                    <option value="sl">Slovenian (sl)</option>
                    <option value="en">English (en)</option>
                    <option value="de">German (de)</option>
                    <option value="fr">French (fr)</option>
                    <option value="es">Spanish (es)</option>
                    <option value="it">Italian (it)</option>
                    <option value="pt">Portuguese (pt)</option>
                    <option value="nl">Dutch (nl)</option>
                    <option value="pl">Polish (pl)</option>
                    <option value="cs">Czech (cs)</option>
                    <option value="sk">Slovak (sk)</option>
                    <option value="hr">Croatian (hr)</option>
                    <option value="sr">Serbian (sr)</option>
                </select>
            </div>
            <div class="button-group">
                <button onclick="closeModal('addProjectModal')">Cancel</button>
                <button onclick="createProjectWithSettings()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- Edit Project Modal -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Project</h3>
                <span class="close" onclick="closeModal('editProjectModal')">&times;</span>
            </div>
            <div class="form-group">
                <label for="editProjectName">Project Name:</label>
                <input type="text" id="editProjectName" placeholder="Enter project name">
            </div>
            <div class="form-group">
                <label for="editSilenceThreshold">Silence Threshold (dB):</label>
                <input type="number" id="editSilenceThreshold" value="-40" step="1" min="-100" max="0">
            </div>
            <div class="form-group">
                <label for="editMinSilenceLength">Minimum Silence Length (ms):</label>
                <input type="number" id="editMinSilenceLength" value="500" step="100" min="100">
            </div>
            <div class="form-group">
                <label for="editMaxSpeakers">Max Speakers (0 = auto-detect):</label>
                <input type="number" id="editMaxSpeakers" value="0" step="1" min="0" max="20">
            </div>
            <div class="form-group">
                <label for="editSilencePad">Silence Padding (ms):</label>
                <input type="number" id="editSilencePad" value="50" step="10" min="0" max="500">
            </div>
            <div class="form-group">
                <label for="editLanguage">Transcription Language:</label>
                <select id="editLanguage">
                    <option value="sl">Slovenian (sl)</option>
                    <option value="en">English (en)</option>
                    <option value="de">German (de)</option>
                    <option value="fr">French (fr)</option>
                    <option value="es">Spanish (es)</option>
                    <option value="it">Italian (it)</option>
                    <option value="pt">Portuguese (pt)</option>
                    <option value="nl">Dutch (nl)</option>
                    <option value="pl">Polish (pl)</option>
                    <option value="cs">Czech (cs)</option>
                    <option value="sk">Slovak (sk)</option>
                    <option value="hr">Croatian (hr)</option>
                    <option value="sr">Serbian (sr)</option>
                </select>
            </div>
            <div class="button-group">
                <button onclick="closeModal('editProjectModal')">Cancel</button>
                <button onclick="updateProjectWithSettings()">Update Project</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="https://unpkg.com/nprogress@0.2.0/nprogress.js"></script>
    <script src="web/js/main.js"></script>
    <script src="web/js/audio-controller.js"></script>
    <script src="web/js/segments-manager.js"></script>
    <script src="web/components/data-viewer/data-viewer.js"></script>
    
    <script>
        // Configure NProgress
        NProgress.configure({ 
            showSpinner: false,
            minimum: 0.08,
            easing: 'ease',
            speed: 200
        });

        // Track active HTTP requests
        let activeRequests = 0;

        // Override fetch to automatically show/hide progress bar
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            // Start progress if this is the first request
            if (activeRequests === 0) {
                NProgress.start();
            }
            activeRequests++;

            return originalFetch.apply(this, args)
                .then(response => {
                    activeRequests--;
                    // Complete progress if this was the last request
                    if (activeRequests === 0) {
                        NProgress.done();
                    }
                    return response;
                })
                .catch(error => {
                    activeRequests--;
                    // Complete progress even on error
                    if (activeRequests === 0) {
                        NProgress.done();
                    }
                    throw error;
                });
        };

        // Initialize the data viewer component when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Load the data viewer HTML into the component container
            fetch('web/components/data-viewer/data-viewer.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('dataViewerComponent').innerHTML = html;
                    // Setup data viewer listeners after the component is loaded
                    if (window.podcastManager) {
                        window.podcastManager.setupDataViewerListeners();
                    }
                })
                .catch(error => {
                    console.error('Error loading data viewer component:', error);
                });
        });
    </script>
</body>
</html>
